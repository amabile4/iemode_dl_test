# IEモード自動化スクリプト コードレビュー報告

**レビュー日**: 2026-02-07
**レビューチーム**: code-review
**対象ファイル**:
- `automation/ie_mode_test.py` (COM方式)
- `automation/selenium_ie_test.py` (Selenium方式)

---

## 目次

1. [全体サマリー](#全体サマリー)
2. [COM方式レビュー結果](#com方式レビュー結果)
3. [Selenium方式レビュー結果](#selenium方式レビュー結果)
4. [両方式の比較](#両方式の比較)
5. [社内システムへの移植ガイド](#社内システムへの移植ガイド)
6. [推奨される改善事項](#推奨される改善事項)
7. [Claudeチーム機能のレビュー](#claudeチーム機能のレビュー)

---

## 全体サマリー

### 評価概要

| 項目 | COM方式 | Selenium方式 |
|------|---------|--------------|
| 全体評価 | B (良好) | B+ (良好) |
| コード行数 | 392行 | 675行 |
| 依存関係 | comtypes, pywinauto | selenium, pywinauto, IEDriverServer |
| 品質の均質性 | ✓ | ✓ |

### 結論

**両方式とも品質基準を満たしており、社内システムへの移植が可能です。**

- **機能の同等性**: 両方式ともIEモードでのログイン、ダウンロード、ファイル保存操作を実現
- **移植の容易さ**: COM方式は設定項目が少なく簡易、Selenium方式は堅牢だが設定が複雑
- **推奨用途**: 長期運用にはSelenium方式、プロトタイプにはCOM方式

---

## COM方式レビュー結果

### ファイル: `automation/ie_mode_test.py`

#### 全体評価: **B (良好)**

IEモード固有の課題（COMオブジェクト操作、マルチスレッドでのダイアログ処理、pywinautoによるUI自動化）に対して、適切な設計選択がされています。

#### 良い点

1. **プロセス管理の工夫** (53-73行目)
   - 起動前後のPIDスナップショット比較で、自身が起動したプロセスだけを特定・終了
   - 他のIEプロセスに影響を与えない安全なクリーンアップ

2. **マルチスレッドによるダイアログ処理** (140-162行目)
   - COMの `link.click()` が confirmダイアログでブロックする問題を、daemonスレッドで適切に回避

3. **フォールバック戦略** (234-322行目)
   - 「名前を付けて保存」ダイアログで4つの異なるアプローチを用意
   - OS/言語設定の差異に対する堅牢性

4. **適切なリソースクリーンアップ** (380-387行目)
   - `finally` ブロックで確実にクリーンアップ

#### 改善すべき点

| 優先度 | 項目 | 詳細 |
|--------|------|------|
| 高 | 設定の分離 | 環境変数または設定ファイル化 |
| 中 | タイムアウト値のパラメータ化 | マジックナンバーの定数化 |
| 中 | プラットフォーム依存の解消 | Windowsコマンド依存の回避 |
| 低 | ログの構造化 | loggingモジュールの使用 |

#### 重大な問題

**なし** - 主要なエラーケースで適切な例外処理あり

---

## Selenium方式レビュー結果

### ファイル: `automation/selenium_ie_test.py`

#### 全体評価: **B+ (良好)**

IEモード特有の問題に対処しつつ、Seleniumとpywinautoを組み合わせた実用的な自動化スクリプトです。堅牢性とエラー処理は全体的に良好です。

#### 良い点

1. **堅牢なタイムアウト処理**
   - `create_driver()`（167-218行目）でスレッドを使用した起動タイムアウト実装
   - ダウンロード完了待機（556-616行目）で複数条件チェック

2. **IEモード固有の問題への適切な対応**
   - pywinautoのキーボード操作を使用し、clickの失敗を回避
   - 上書き確認ダイアログのボタンテキスト正規化

3. **詳細なログ機能**
   - タイムスタンプ付きのログファイル出力
   - ダイアログ情報の詳細なログ出力

#### 改善すべき点

| 優先度 | 項目 | 詳細 |
|--------|------|------|
| 高 | 設定の外部化 | 環境変数や設定ファイルの活用 |
| 高 | 型ヒント追加 | IDE支援と保守性向上 |
| 中 | クラス化 | グローバル変数のカプセル化 |
| 中 | pathlib使用 | クロスプラットフォーム対応 |

#### 重大な問題

1. **パスの絶対パス前提** - 特定のWindows環境に固定
2. **リソースリークのリスク** - タイムアウト時のIEDriverServer残存可能性
3. **COMErrorの再試行ロジックが不完全** - 最終的な失敗時のフォールバック不足

---

## 両方式の比較

### 実装方式の比較表

| 観点 | COM方式 | Selenium方式 |
|------|---------|--------------|
| **ブラウザ起動** | `comtypes.client.CreateObject("InternetExplorer.Application")` | `selenium.webdriver.Ie()` + IEDriverServer |
| **要素操作** | COM経由でHTMLDocumentオブジェクトを直接操作 | Selenium標準API (WebDriver + WebDriverWait) |
| **ダイアログ処理** | pywinauto (win32 backend) | pywinauto (win32 backend) |
| **プロセス管理** | iexplore.exe PIDを追跡 | msedge.exe (IEモード) PIDを追跡 (PowerShell使用) |
| **ダウンロードバー操作** | pywinauto (UIA)で要素クリック | pywinauto + キーボード操作のみ |
| **保存ダイアログ操作** | 多重フォールバック | 要素操作優先 + 上書き確認の厳格な処理 |
| **ログ機能** | print文のみ | loggingモジュールでファイル + 標準出力 |
| **ダウンロード完了検知** | time.sleepのみ | `.partial`ファイル監視 |
| **エラーハンドリング** | 基本的なtry-except | 詳細なログ + リトライ機構 |

### 品質の差分

#### Selenium方式の優位点
- 堅牢なダウンロード完了検知（`.partial`ファイル監視）
- 詳細なロギング（ファイルへ時刻付きログ）
- 要素定義の分離（ロケーターや待機時間を定数化）
- 起動タイムアウト処理
- 上書き確認ダイアログの厳格な処理
- リトライ機構（ダウンロードバー操作で3回）

#### COM方式の優位点
- コードの簡潔さ（392行 vs 675行）
- 依存関係が少ない（IEDriverServer不要）
- 即時性（COM直接呼び出しで起動高速）

---

## 社内システムへの移植ガイド

### 共通の移植手順

#### 1. 設定値の変更

```python
# 対象システムのURLに変更
BASE_URL = "http://your-internal-system"

# 保存先パスを変更
SAVE_PATH = r"C:\Temp\download"

# 認証情報を変更
USER_ID = "your-user-id"
PASSWORD = "your-password"
```

#### 2. UI要素の確認

対象システムの以下の要素を確認・変更：

| 要素 | COM方式 | Selenium方式 |
|------|---------|--------------|
| ユーザーID入力 | `txtUserID` | `LOC_USER_ID` |
| パスワード入力 | `txtPassWord` | `LOC_PASSWORD` |
| ダウンロードリンク | `/download/csv` | `LOC_DOWNLOAD_LINK` |

### COM方式の移植

#### メリット
- 設定項目が少ない
- IEDriverServerが不要

#### 注意点
- IE11/Edge IEモードのCOM登録状況に依存
- レガシーIEの非推奨化に伴う将来性の懸念

#### 移植チェックリスト
- [ ] COMコンポーネントが有効であること
- [ ] pywinautoがインストールされていること
- [ ] 対象URLがIEモードでアクセス可能であること

### Selenium方式の移植

#### メリット
- 詳細なログでトラブルシュートが容易
- 構造化されており変更に強い

#### 注意点
- IEDriverServerのバージョンとEdgeの互換性を確認
- PowerShellコマンドの実行権限が必要

#### 移植チェックリスト
- [ ] IEDriverServer.exe を配置しパスを設定
- [ ] Edgeの実行パスを確認
- [ ] PowerShellの実行権限があること
- [ ] ログ出力先ディレクトリの作成

---

## 推奨される改善事項

### 優先度: 高

#### 1. 設定の外部化

両方式とも設定値をハードコードから外部化することを推奨：

```python
# 推奨: config.py または .env ファイルを使用
import os
from dotenv import load_dotenv

load_dotenv()

BASE_URL = os.getenv("BASE_URL", "http://localhost:5000")
SAVE_PATH = os.getenv("SAVE_PATH", r"C:\Temp\download")
USER_ID = os.getenv("USER_ID")
PASSWORD = os.getenv("PASSWORD")
```

#### 2. 型ヒントの追加

```python
def get_pids(process_name: str) -> set[int]:
    """指定プロセス名の現在のPID一覧を取得する"""
    ...
```

### 優先度: 中

#### 3. クラス化による再利用性向上

```python
class IEModeAutomation:
    def __init__(self, config: dict):
        self.base_url = config["base_url"]
        self.save_path = config["save_path"]
        ...

    def login(self, user_id: str, password: str):
        ...

    def download(self, url: str):
        ...
```

---

## Claudeチーム機能のレビュー

### メリット

1. **並列作業の効率性**
   - 3人のレビュアーを同時に起動し、それぞれ独立したレビューを実行可能
   - reviewer-com、reviewer-selenium、comparatorが同時に作業を完了

2. **役割分担の明確化**
   - 各エージェントに異なる視点でのレビューを割り当て可能
   - 専門性を持たせたタスク分担が容易

3. **統合された結果管理**
   - チームタスクリストで進捗を一元管理
   - メンバー間のメッセージングで結果収集がスムーズ

### 今回の活用における工夫点

1. **適切なタスク分割**
   - COM方式レビュー
   - Selenium方式レビュー
   - 比較レビュー
   という独立した3つのタスクに分割

2. **明確な出力形式指定**
   - 各レビュアーに統一されたフォーマットで結果を依頼
   - 統合が容易な構造

### 改善の余地

1. **結果の自動統合**
   - 今回は手動で結果を収集・統合
   - 自動的にマージされる仕組みがあるとより効率的

2. **進捗通知の詳細化**
   - アイドル通知のみで、タスク完了の明示的な通知がない
   - 進捗状況のより詳細な可視化が望ましい

### チーム機能を使いこなすための推奨事項

1. **タスクは独立させる**
   - 依存関係のないタスクを並列実行させる

2. **明確な役割定義**
   - 各メンバーの担当範囲と期待される出力を明確にする

3. **統一されたフォーマット**
   - 結果を統合しやすい形式で出力を依頼する

4. **適切なタイミングでの結果収集**
   - アイドル通知を待ってから結果を要求する

5. **リーダーの役割**
   - 結果の統合と最終的な品質確認はリーダーが行う

---

## 結論

### 品質保証の観点より

**両方式とも品質基準を満たしており、社内システムへの移植が可能であることを確認しました。**

### 推奨される使い分け

| シナリオ | 推奨方式 | 理由 |
|----------|----------|------|
| 社内RPAプロジェクト | Selenium方式 | ログ、エラーハンドリング、保守性が優れている |
| 迅速なプロトタイプ作成 | COM方式 | コードがシンプルで理解しやすく、素早く作動可能 |
| 長期運用が見込まれる | Selenium方式 | 構造化されており、変更に強い |
| IEDriverServer導入が難しい | COM方式 | 追加ツール不要 |

### 最終評価

**本プロジェクトの目的である「IEモード動作社内システムの自動化サンプル」として、両方式とも十分な品質を有しています。用途に応じて適切な方式を選択することを推奨します。**
